{% extends "base.html" %}

{% block title %}Call Logs - FreePBX AI Assistant{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Call Logs</h1>
    <p class="page-subtitle">Track and analyze all your call interactions</p>
</div>

<!-- Filters -->
<div class="card mb-3" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
    <div class="card-body">
        <form method="GET" action="{{ url_for('admin.call_logs') }}" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label for="status" class="form-label" style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);">Status</label>
                <select class="form-select" id="status" name="status" style="border-radius: 10px; border: 2px solid #e5e7eb;">
                    <option value="">All Statuses</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="escalated" {% if status_filter == 'escalated' %}selected{% endif %}>Escalated</option>
                    <option value="error" {% if status_filter == 'error' %}selected{% endif %}>Error</option>
                </select>
            </div>

            <div class="col-md-2">
                <label for="escalated" class="form-label" style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);">Escalated</label>
                <select class="form-select" id="escalated" name="escalated" style="border-radius: 10px; border: 2px solid #e5e7eb;">
                    <option value="">All</option>
                    <option value="true" {% if escalated_filter == 'true' %}selected{% endif %}>Yes</option>
                    <option value="false" {% if escalated_filter == 'false' %}selected{% endif %}>No</option>
                </select>
            </div>

            <div class="col-md-3">
                <label for="date_from" class="form-label" style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);">Date From</label>
                <input type="date" class="form-control" id="date_from" name="date_from"
                       value="{{ date_from }}" style="border-radius: 10px; border: 2px solid #e5e7eb;">
            </div>

            <div class="col-md-3">
                <label for="date_to" class="form-label" style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);">Date To</label>
                <input type="date" class="form-control" id="date_to" name="date_to"
                       value="{{ date_to }}" style="border-radius: 10px; border: 2px solid #e5e7eb;">
            </div>

            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Calls Table -->
<div class="card">
    <div class="card-body p-0">
        {% if calls %}
        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th>Call ID</th>
                        <th>Caller Number</th>
                        <th>Started At</th>
                        <th>Duration</th>
                        <th>Interactions</th>
                        <th>Status</th>
                        <th>Escalated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for call in calls %}
                    <tr>
                        <td>
                            <code style="padding: 0.35rem 0.65rem; background: #f3f4f6; border-radius: 6px; font-size: 0.8rem;">
                                {{ call.call_id[:16] }}
                            </code>
                        </td>
                        <td style="font-weight: 500;">{{ call.caller_number }}</td>
                        <td style="color: var(--text-secondary);">{{ call.started_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% if call.duration_seconds %}
                                <span style="color: var(--text-secondary);">
                                    {{ call.duration_seconds // 60 }}m {{ call.duration_seconds % 60 }}s
                                </span>
                            {% else %}
                                <span style="color: var(--text-secondary);">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge" style="background: #dbeafe; color: #1e40af;">
                                {{ call.total_interactions }}
                            </span>
                            {% if call.failed_interactions > 0 %}
                                <span class="badge" style="background: #fef3c7; color: #92400e;">
                                    {{ call.failed_interactions }} failed
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{{ 'success' if call.status == 'completed' else 'warning' if call.status == 'active' else 'danger' if call.status == 'error' else 'secondary' }}">
                                {{ call.status }}
                            </span>
                        </td>
                        <td>
                            {% if call.escalated %}
                                <span class="badge" style="background: #fef3c7; color: #92400e;">
                                    <i class="fas fa-arrow-up"></i>
                                    {% if call.escalated_to_department %}
                                        {{ call.escalated_to_department.name }}
                                    {% else %}
                                        Yes
                                    {% endif %}
                                </span>
                            {% else %}
                                <span style="color: var(--text-secondary);">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('admin.call_detail', call_id=call.id) }}"
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i> View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if pagination.pages > 1 %}
        <nav aria-label="Call log pagination" class="mt-3 px-3 pb-3">
            <ul class="pagination justify-content-center mb-0">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('admin.call_logs', page=pagination.prev_num, status=status_filter, escalated=escalated_filter, date_from=date_from, date_to=date_to) }}" style="border-radius: 10px; margin: 0 0.25rem;">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>

                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('admin.call_logs', page=page_num, status=status_filter, escalated=escalated_filter, date_from=date_from, date_to=date_to) }}" style="border-radius: 10px; margin: 0 0.25rem;">
                                {{ page_num }}
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link" style="border-radius: 10px; margin: 0 0.25rem;">...</span></li>
                    {% endif %}
                {% endfor %}

                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('admin.call_logs', page=pagination.next_num, status=status_filter, escalated=escalated_filter, date_from=date_from, date_to=date_to) }}" style="border-radius: 10px; margin: 0 0.25rem;">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}

        {% else %}
        <div class="text-center py-5">
            <div style="width: 80px; height: 80px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                <i class="fas fa-inbox fa-2x" style="color: var(--text-secondary);"></i>
            </div>
            <p style="color: var(--text-secondary); font-size: 1.1rem; font-weight: 500;">No calls found</p>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">Try adjusting your filters or check back later</p>
        </div>
        {% endif %}
    </div>
</div>

{% block extra_css %}
<style>
    .page-link {
        color: var(--primary-color);
        border: 2px solid #e5e7eb;
        font-weight: 600;
    }

    .page-link:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .page-item.active .page-link {
        background: var(--primary-color);
        border-color: var(--primary-color);
    }

    .page-item.disabled .page-link {
        background: #f9fafb;
        border-color: #e5e7eb;
    }
</style>
{% endblock %}
{% endblock %}